#!/usr/bin/env bash

set -euo pipefail

main() {
  case "${1:-invalid}" in
    list)
      list_command
      shift
      ;;
    get)
      get_command
      shift
      ;;
    set)
      set_command
      shift
      ;;
    *)
      print_usage_and_exit
      ;;
  esac
}

is_linux() {
  [[ "Linux" = "$(uname)" ]]
}

# Confident that checking for a c mountpoint is indictive of running on WSL
is_wsl() {
  [[ -d /mnt/c ]]
}

list_command() {
  if is_linux && is_wsl; then
    ls ~/workspace/infrastructure/homedirs/common/dotfiles/dot.config/alacritty/alacritty-theme/themes/ | sort
    nvim --headless -c 'lua io.write(table.concat(vim.fn.getcompletion("", "color"), "\n"))' -c 'quit' 2>/dev/null
  elif is_linux; then
    ls ~/.config/alacritty/alacritty-theme/themes/ | sort
    nvim --headless -c 'lua io.write(table.concat(vim.fn.getcompletion("", "color"), "\n"))' -c 'quit' 2>/dev/null
    ls /usr/share/themes/ | sort
  fi
}


get_command() {
  if is_linux && is_wsl; then
    echo Woohoo
  elif is_linux; then
    sed 's/.*themes\/\([^.]*\)\.toml.*/\1/' ~/.config/alacritty/selected_theme.toml
    cat ~/.config/nvim/lua/selected_colorscheme.lua | grep colorscheme | cut -d' ' -f 2
    gsettings get org.gnome.desktop.interface gtk-theme
    gsettings get org.gnome.shell.ubuntu color-scheme
    gsettings get org.gnome.desktop.interface color-scheme
  fi
}

set_command() {
  if is_linux && is_wsl; then
    echo "vim.cmd.colorscheme 'cyberdream'" > ~/.config/nvim/lua/selected_colorscheme.lua
  elif is_linux; then
    echo "vim.cmd.colorscheme 'cyberdream'" > ~/.config/nvim/lua/selected_colorscheme.lua
    echp "general.import = [ \"~/.config/alacritty/alacritty-theme/themes/alabaster_dark.toml\" ]" \
      > ~/.config/alacritty/selected_theme.toml
  fi
}

print_usage_and_exit() {
  cat <<USAGE
usage: $0 <command>

Commands:
 - list
     list all the available themes

 - get
     get the current theme in relevant applications

 - set
     sets the theme in relevant applications

USAGE

  exit 1
}

main "$@"
