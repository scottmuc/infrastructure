# This requires that nginx isn't up and running and listening on port 80 so it
# must run before the nginx tasks. Subsequent runs will be idempotent as long
# as the certificates have been provisioned.
- name: Setup certbot and install certificates
  ansible.builtin.include_tasks: certificates.yml

- name: Install nginx package
  ansible.builtin.apt:
    name: nginx

# Depends on certificates being placed as well as the filesystem layout by
# by the nginx tasks, so this must be after those two sets of tasks.
- name: Setup nginx vhosts
  ansible.builtin.include_tasks: vhosts.yml


# Favouring complete overwrite of the configuration file coming from the
# package manager due to reasons identified here:
# https://serverfault.com/questions/825363/override-default-nginx-http-configuration-without-changing-default-nginx-conf
- name: Nginx configuration
  ansible.builtin.copy:
    src: root/etc/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: admin
    mode: '0664'
  notify:
    - Restart nginx


- name: Enable stub_status
  ansible.builtin.copy:
    src: root/etc/nginx/conf.d/status.conf
    dest: /etc/nginx/conf.d/status.conf
    owner: root
    group: admin
    mode: '0664'
  notify:
    - Restart nginx


# Only ensure nginx is started after all the webserver related configuration
# has been applied. See the following comment as for the context:
# https://github.com/scottmuc/infrastructure/issues/74#issuecomment-2156133447
- name: Start nginx
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true

# vim: ft=yaml.ansible
