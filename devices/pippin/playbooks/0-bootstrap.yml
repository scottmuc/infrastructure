- name: Bootstrap raspberry pi device to enable ansible automation runs.
  hosts: pippin.middle-earth.internal.
  remote_user: bootstrap
  gather_facts: false
  become: true

  # Raspian image sets up the bootstrap user to be able to sudo, and we
  # need to override inventory configuration since we don't have doas yet.
  become_method: sudo

  pre_tasks:
    - name: Attempt to update apt's cache
      ansible.builtin.apt:
        update_cache: true

  tasks:
    - name: Create admin user group
      ansible.builtin.group:
        name: admin
        system: true
        state: present

    - name: Ensure doas is installed
      ansible.builtin.package:
        name: doas
        state: present

    - name: Create ansible user
      ansible.builtin.user:
        name: ansible
        shell: /bin/bash
        comment: "Ansible management user"
        home: /home/ansible
        createhome: true

    - name: Add ansible user to admin group
      ansible.builtin.user:
        name: ansible
        groups: admin
        append: true

    - name: Permit ansible to elevate privileges without root password
      ansible.builtin.copy:
        dest: /etc/doas.conf
        owner: root
        group: admin
        mode: '0640'
        content: |
          permit nopass ansible

    - name: Initialized authorized_keys for the ansible user
      ansible.posix.authorized_key:
        user: ansible
        state: present
        key: "{{ lookup('file', '../../authorized_keys') }}"

# vim: ft=yaml.ansible
