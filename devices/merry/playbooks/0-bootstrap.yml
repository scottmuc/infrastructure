- name: Bootstrap a Debian ecosystem machine
  hosts: merry.middle-earth.internal.
  remote_user: bootstrap
  gather_facts: false
  become: true
  become_method: ansible.builtin.su

  pre_tasks:
    - name: Attempt to update apt's cache
      ansible.builtin.apt:
        update_cache: true

  tasks:
    - name: Create admin user group
      ansible.builtin.group:
        name: admin
        system: true
        state: present

    - name: Ensure doas is installed
      ansible.builtin.package:
        name: doas
        state: present

    - name: Create Ansible user
      ansible.builtin.user:
        name: ansible
        shell: /bin/bash
        comment: "Ansible management user"
        home: /home/ansible
        createhome: true

    - name: Add Ansible user to admin group
      ansible.builtin.user:
        name: ansible
        groups: admin
        append: true

    - name: Permit ansible to elevate privileges without root password
      ansible.builtin.copy:
        dest: /etc/doas.conf
        owner: root
        group: admin
        mode: '0640'
        content: |
          permit nopass ansible

    - name: Add authorized keys
      ansible.posix.authorized_key:
        user: ansible
        state: present
        key: "{{ lookup('file', '../../authorized_keys') }}"

# vim: ft=yaml.ansible
